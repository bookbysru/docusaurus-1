<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>OPQ Box Updater · Open Power Quality</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="OPQ Box Updater · Open Power Quality"/><meta property="og:type" content="website"/><meta property="og:url" content="https://openpowerquality.org/index.html"/><meta property="og:description" content="This document contains the technical information for the OPQBox updater. If you are looking for instruction on updating your OPQBox, see the [OPQ Box User Guide](/docs/userguide-hardware.html)."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/opq.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://openpowerquality.org/blog/atom.xml" title="Open Power Quality Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://openpowerquality.org/blog/feed.xml" title="Open Power Quality Blog RSS Feed"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Gugi"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/javascript" src="/js/mathjax-config.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/opqlogo_white.png" alt="Open Power Quality"/><h2 class="headerTitleWithLogo">Open Power Quality</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/intro-motivation.html" target="_self">Documentation</a></li><li class="siteNavGroupActive"><a href="/docs/other-opportunities.html" target="_self">Opportunities</a></li><li class=""><a href="/blog" target="_self">News</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>OPQ Box</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Introduction</h3><ul><li class="navListItem"><a class="navItem" href="/docs/intro-motivation.html">Motivation for OPQ</a></li><li class="navListItem"><a class="navItem" href="/docs/intro-power-quality.html">A beginner&#x27;s guide to power quality</a></li><li class="navListItem"><a class="navItem" href="/docs/intro-system-architecture.html">OPQ System Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/intro-information-architecture.html">OPQ Information Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/intro-related-work.html">Related Work</a></li><li class="navListItem"><a class="navItem" href="/docs/intro-bibliography.html">Bibliography</a></li></ul></div><div class="navGroup navGroupActive"><h3>User Guide</h3><ul><li class="navListItem"><a class="navItem" href="/docs/userguide-hardware.html">OPQ Box</a></li><li class="navListItem"><a class="navItem" href="/docs/userguide-software.html">OPQ Cloud</a></li></ul></div><div class="navGroup navGroupActive"><h3>OPQ Box</h3><ul><li class="navListItem"><a class="navItem" href="/docs/box-overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/box-hardware-design.html">Hardware Design</a></li><li class="navListItem"><a class="navItem" href="/docs/box-software-design.html">Software Design</a></li><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/docs/box-updater.html">Updater</a></li><li class="navListItem"><a class="navItem" href="/docs/box-manufacturing.html">Manufacturing</a></li></ul></div><div class="navGroup navGroupActive"><h3>OPQ Cloud</h3><ul><li class="navListItem"><a class="navItem" href="/docs/cloud-overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-datamodel.html">Data Model</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-view.html">View</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-mauka.html">Mauka</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-makai.html">Makai</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-health.html">Health</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-protocol.html">Protocol</a></li><li class="navListItem"><a class="navItem" href="/docs/cloud-port-map.html">Port Map</a></li></ul></div><div class="navGroup navGroupActive"><h3>Misc Development</h3><ul><li class="navListItem"><a class="navItem" href="/docs/developerguide-docusaurus.html">Documentation</a></li><li class="navListItem"><a class="navItem" href="/docs/developerguide-virtual-machine.html">VM &amp; Sim</a></li><li class="navListItem"><a class="navItem" href="/docs/developerguide-bibliography.html">Bibliography</a></li></ul></div><div class="navGroup navGroupActive"><h3>Deployment</h3><ul><li class="navListItem"><a class="navItem" href="/docs/deploy-initial-configuration.html">Initial Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-mongodb.html">MongoDB</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-mauka.html">Mauka</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-makai.html">Makai</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-view.html">View</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-health.html">Health</a></li><li class="navListItem"><a class="navItem" href="/docs/deploy-docker.html">Docker</a></li></ul></div><div class="navGroup navGroupActive"><h3>Other</h3><ul><li class="navListItem"><a class="navItem" href="/docs/other-roadmap.html">Roadmap</a></li><li class="navListItem"><a class="navItem" href="/docs/other-opportunities.html">R&amp;D Opportunities</a></li><li class="navListItem"><a class="navItem" href="/docs/other-agile-power-monitoring.html">Agile Power Monitoring for UH</a></li><li class="navListItem"><a class="navItem" href="/docs/other-g1-pilot-study.html">G1 Pilot Study (2014)</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>OPQ Box Updater</h1></header><article><div><span><p>This document contains the technical information for the OPQBox updater. If you are looking for instruction on updating your OPQBox, see the <a href="/docs/userguide-hardware.html">OPQ Box User Guide</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="summary"></a><a href="#summary" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Summary</h2>
<p>The OPQBox updater provides a way to update any OPQBox to the latest OPQBox software. Updating an OPQBox involves building an OPQBox image, hosting that image on an application server, downloading that image to a Box, and installing the image on a Box. This document will detail these steps.</p>
<p>All OPQBox updates are completely atomic and independent. That means each update should contain everything needed to stop, erase, and install all required Box services and software. This eliminates the need to track versions and each box can always update directly to the latest version indepdendent of the version it is currently on.</p>
<h3><a class="anchor" aria-hidden="true" id="building-an-opq-box-image"></a><a href="#building-an-opq-box-image" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Building an OPQ Box Image</h3>
<p>An OPQ Box update image is a compressed .tar.bz2 archive that contains version information, and install script, and install binaries and scripts.</p>
<p>Updates are named using the template: <code>opq-box-update-[VERSION]</code> where version is replaced by the timestamp of when the update was built which represents the number of seconds since the epoch.</p>
<p>Update distributions take the form of <code>opq-box-update-[VERSION].tar.bz2</code>.</p>
<p>An update distribution should contain the following layout and files:</p>
<ul>
<li>./VERSION -- a text file containing the reference update version</li>
<li>./install_update.sh -- a shell script that performs the update on an OPQ Box</li>
<li>./box-configuration-daemon/ -- Updated sources for the OPQ Box Configuration Daemon</li>
<li>[TODO] -- list layout for triggering, kernels, and firmware</li>
</ul>
<p>The building of OPQ Box update distributions can be automated by calling the <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-updater/build_update.sh">opq/box/Software/box-updater/build-update.sh</a> script. This script will build an OPQ Box update distribution in the current directory. This distribution can then be transferred to the box-update-server for hosting.</p>
<p>The included <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-updater/install_update.sh">install_update.sh</a> should always stop all Box services, install fresh versions of all services, and then reboot the box.</p>
<h3><a class="anchor" aria-hidden="true" id="box-update-server"></a><a href="#box-update-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>box-update-server</h3>
<p>The <a href="https://github.com/openpowerquality/opq/tree/master/util/box-update-server">box-update-server</a> is a pure Python 3 HTTP application server that can be ran as a docker service. The image can be found on dockerhub as <a href="https://cloud.docker.com/u/openpowerquality/repository/docker/openpowerquality/opqboxupdateserver">openpowerquality/opqboxupdateserver</a>.</p>
<p>The application server takes two arguments to start which include a port number for the server to run on and a directory on the host system that contains (or will contain) Box updates. These are currently configured and passed in using the <a href="https://github.com/openpowerquality/opq/blob/master/util/box-update-server/docker/docker-run.sh">docker-run.sh</a> script. By default, the docker-run.sh file assumes that the update directory <code>/var/opq/box-updates</code> exists. If this directory does not exist, you should create it before running the box-update-server.</p>
<p>The box-update-server provides the following 5 HTTP endpoints:</p>
<table>
<thead>
<tr><th>Endpoint</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>/</td><td>Returns an empty 200 OK. Useful for health checks.</td></tr>
<tr><td>/ls</td><td>Returns a list of available box updates on this server</td></tr>
<tr><td>/version</td><td>Returns the latest available update version as number of seconds since the epoch</td></tr>
<tr><td>/update/[UPDATE]</td><td>Returns a file where [UPDATE] is replaced with the update name</td></tr>
<tr><td>/latest</td><td>Returns a file with the latest box update (by redirecting to /update/[UPDATE] and replacing [UPDATE] with the latest update name)</td></tr>
</tbody>
</table>
<p>These endpoints can be queried to obtain information about updates and to receive the updates themselves.</p>
<p>You can see examples of all of these on the emilia opq update server:</p>
<ul>
<li><a href="http://emilia.ics.hawaii.edu:8151/">http://emilia.ics.hawaii.edu:8151/</a></li>
<li><a href="http://emilia.ics.hawaii.edu:8151/ls">http://emilia.ics.hawaii.edu:8151/ls</a></li>
<li><a href="http://emilia.ics.hawaii.edu:8151/version">http://emilia.ics.hawaii.edu:8151/version</a></li>
<li><a href="http://emilia.ics.hawaii.edu:8151/update/opq-box-update-1547860803.tar.bz2">http://emilia.ics.hawaii.edu:8151/update/opq-box-update-1547860803.tar.bz2</a></li>
<li><a href="http://emilia.ics.hawaii.edu:8151/latest">http://emilia.ics.hawaii.edu:8151/latest</a></li>
</ul>
<p>When the box-update-server is started, an update_dir is specified. Update distributions should be placed in this directory and the box-update-server will observe changes when files are added or removed without restarting the server.</p>
<h3><a class="anchor" aria-hidden="true" id="installing-an-update-on-an-opq-box"></a><a href="#installing-an-update-on-an-opq-box" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installing an update on an OPQ Box</h3>
<p>Updates are currently triggered when a Box owner opens the OPQ Box Config Daemon interface and clicks the <code>Update Box</code> button.</p>
<ol>
<li>The update action is triggered by the GET request generated from the <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-config-daemon/box-config-daemon.html">OPQ Box Config Daemon web interface</a>.</li>
<li>The GET request is handled by the <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-config-daemon/http_server.py">OPQ Box Config Daemon HTTP Server</a>.</li>
<li>The GET request handler calls a <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-config-daemon/updater/updater.py">Python module</a> which wraps a <a href="https://github.com/openpowerquality/opq/blob/master/box/Software/box-config-daemon/updater/updater.sh">bash script</a> that instructs the Box to download the latest update and runs an included install script that stops box services, installs the updates, and reboots the Box.</li>
</ol>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="box-software-design.html">← OPQ Box Software Design</a><a class="docs-next button" href="box-manufacturing.html">Manufacturing an OPQ Box →</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#summary">Summary</a><ul class="toc-headings"><li><a href="#building-an-opq-box-image">Building an OPQ Box Image</a></li><li><a href="#box-update-server">box-update-server</a></li><li><a href="#installing-an-update-on-an-opq-box">Installing an update on an OPQ Box</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/opqlogo_white.png" alt="Open Power Quality" width="66" height="58"/></a><div><h5>Documentation Quick Links</h5><a href="/docs/intro-opq.html">Overview</a><a href="/docs/userguide-hardware.html">OPQ Box User Guide</a><a href="/docs/userguide-software.html">OPQ View User Guide</a><a href="/docs/other-agile-power-monitoring.html">Agile Power Monitoring for UH</a><a href="/docs/other-roadmap.html">Roadmap</a></div><div><h5>Community</h5><a href="https://openpowerquality.slack.com/" target="_blank" rel="noreferrer noopener">Slack</a><a href="https://twitter.com/opquality" target="_blank" rel="noreferrer noopener">Twitter</a><a href="/blog">News</a><a href="http://emilia.ics.hawaii.edu">Emilia (public OPQ View)</a><a href="/contact-us.html">Contact Us</a></div><div><h5>Development</h5><a href="https://github.com/openpowerquality">GitHub</a><a href="https://github.com/openpowerquality/opq/projects">Project Boards</a><a href="/team.html">Developer Team</a><a href="/docs/opportunities.html">Opportunities</a></div></section><p style="text-align:center;color:#e9faff">Open Power Quality is sponsored by:<br/><a style="text-align:center;color:#e9faff" href="http://csdl.ics.hawaii.edu">Collaborative Software Development Laboratory, University of Hawaii</a><br/><a style="text-align:center;color:#e9faff" href="http://www.ics.hawaii.edu">Department of Information and Computer Sciences, University of Hawaii</a><br/><a style="text-align:center;color:#e9faff" href="http://ee.hawaii.edu">Department of Electrical Engineering, University of Hawaii</a><br/></p></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: '9bf16cc78135dbeeb3826894ebbbb2ee',
                indexName: 'openpowerquality',
                inputSelector: '#search_input_react'
              });
            </script></body></html>